# Dashboard

## Table of Contents
* [Overview](#Overview)
* [Prerequisites](#Prerequisites)
* [Running Locally](#Running-Locally)
	* [On your machine](#On-your-machine)
* [Running in Docker](#Running-in-Docker)
* [How to get the Superfacility API credentials](#How-to-get-the-Superfacility-API-credentials)
* [For Developers](#For-Developers)
	* [How to generate the conda environment lock file](#How-to-generate-the-conda-environment-lock-file)
	* [How to build and publish the Docker container](#How-to-build-and-publish-the-Docker-container)
* [References](#References)


## Overview

The Synapse dashboard provides a web-based interface for visualizing and interacting with data from experiments, simulations, and ML models.

The dashboard can be run in two distinct ways:

1. In a local Python environment, for development, testing and debugging.

2. In a Docker container, either locally or deployed at NERSC through Spin.

The following sections describe in more detail these two ways of running the dashboard.

## Prerequisites

Make sure you have installed [conda](https://docs.conda.io/) and [Docker](https://docs.docker.com/).

## Running Locally

### On your machine

1. Create the conda environment defined in the lock file (only once):
   ```bash
   conda activate base
   conda install -c conda-forge conda-lock  # if conda-lock is not installed
   conda-lock install --name synapse-gui environment-lock.yml
   ```

2. Open a separate terminal and keep it open while SSH forwarding the database connection:
   ```bash
   ssh -L 27017:mongodb05.nersc.gov:27017 <username>@dtn03.nersc.gov -N
   ```

3. Activate the conda environment:
   ```bash
   conda activate synapse-gui
   ```

4. Set up database settings (read-only):
   ```bash
   export SF_DB_HOST='127.0.0.1'
   export SF_DB_READONLY_PASSWORD='your_password_here'  # Use SINGLE quotes around the password!
   ```

5. Run the dashboard from the `dashboard/` folder via the web browser interface:
   ```bash
   python -u app.py --port 8080
   ```
   You can also run the dashboard as a desktop application as follows:
   ```bash
   python -m pip install pywebview[qt]
   export PYWEBVIEW_GUI=qt
   python -u app.py --app
   ```

6. Terminate the application via `Ctrl` + `C`.

## Running in Docker

1. Open a separate terminal and keep it open while SSH forwarding the database connection:
   ```bash
   ssh -L 27017:mongodb05.nersc.gov:27017 <username>@dtn03.nersc.gov -N
   ```

2. Run the Docker container:
   ```bash
   docker run --network=host -v /etc/localtime:/etc/localtime -v $PWD/ml:/app/ml -e SF_DB_HOST='127.0.0.1' -e SF_DB_READONLY_PASSWORD='your_password_here' synapse-gui
   ```
   For debugging, you can also enter the container without starting the app:
   ```bash
   docker run --network=host -v /etc/localtime:/etc/localtime -v $PWD/ml:/app/ml -e SF_DB_HOST='127.0.0.1' -e SF_DB_READONLY_PASSWORD='your_password_here' -it synapse-gui bash
   ```
   Note that `-v /etc/localtime:/etc/localtime` is necessary to synchronize the time zone in the container with the host machine.

## How to get the Superfacility API credentials

Following the instructions at [docs.nersc.gov/services/sfapi/authentication/#client](https://docs.nersc.gov/services/sfapi/authentication/#client):

1. Log in to your profile page at [iris.nersc.gov/profile](https://iris.nersc.gov/profile).

2. Click the icon with your username in the upper right of the profile page.

3. Scroll down to the section "Superfacility API Clients" and click "New Client".

4. Enter a client name (e.g., "Synapse"), choose `sf558` for the user, choose "Red" security level, and select either "Your IP" or "Spin" from the "IP Presets" menu, depending on whether the key will be used from a local computer or from Spin.

5. Download the private key file (in pem format) and save it as `priv_key.pem` in the root directory of the dashboard.
   Each time the dashboard is launched, it will automatically find the existing key file and load the corresponding credentials.

6. Copy your client ID and add it on the first line of your private key file as described in the instructions at [nersc.github.io/sfapi_client/quickstart/#storing-keys-in-files](https://nersc.github.io/sfapi_client/quickstart/#storing-keys-in-files):
   ```
   randmstrgz
   -----BEGIN RSA PRIVATE KEY-----
   ...
   -----END RSA PRIVATE KEY-----
   ```

7. Run `chmod 600 priv_key.pem` to change the permissions of your private key file to read/write only.

## For Developers

### How to generate the conda environment lock file

A new conda environment lock file can be generated by running the following commands:

```bash
conda activate base
conda install -c conda-forge conda-lock  # if conda-lock is not installed
conda-lock --file environment.yml --lockfile environment-lock.yml
```

### How to build and publish the Docker container

> [!WARNING]
> Pushing a new Docker container affects the production dashboard deployed at NERSC through Spin.

1. Move to the root directory of the repository.

2. Build the Docker image based on `Dockerfile`:
   ```bash
   docker build --platform linux/amd64 -t synapse-gui -f dashboard.Dockerfile .
   ```

3. Publish the container privately to [NERSC registry](https://registry.nersc.gov):
   ```bash
   docker login registry.nersc.gov
   # Username: your NERSC username
   # Password: your NERSC password without 2FA
   ```
   ```bash
   docker tag synapse-gui:latest registry.nersc.gov/m558/superfacility/synapse-gui:latest
   docker tag synapse-gui:latest registry.nersc.gov/m558/superfacility/synapse-gui:$(date "+%y.%m")
   docker push -a registry.nersc.gov/m558/superfacility/synapse-gui
   ```
   This has been also automated through the Python script [publish_container.py](../publish_container.py), which can be executed via
   ```bash
   python publish_container.py --gui
   ```

4. (Optional) As you develop the container, you might want to prune old, unused images periodically in order to free space on your development machine:
   ```bash
   docker system prune -a
   ```

## References

* [Using NERSC's `registry.nersc.gov`](https://docs.nersc.gov/development/containers/registry/)
* [Superfacility API authentication](https://docs.nersc.gov/services/sfapi/authentication/#client)