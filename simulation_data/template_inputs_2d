# GPU-aware MPI optimizations
amrex.use_gpu_aware_mpi=1
#################################
# Domain, Resolution & Numerics
#

# We only run 100 steps for tests
# Disable `max_step` below to run until the physical `stop_time`.
#max_step = 100
# time-scale with highly kinetic dynamics
#stop_time = 0.2e-12            # [s]
# time-scale for converged ion energy in our region of interest
#   notes: - effective acc. time depends on laser pulse
#          - ions will start to leave the box
stop_time = 1.1e-12           # [s]

# grid resolution (cells in x and z)
amr.n_cell = 4096 6144
#amr.n_cell = 8192 12288

# simulation box, no MR
#   note: increase z (space & cells) for converging ion energy

my_constants.x_lo = -40.0e-6
my_constants.x_hi =  40.0e-6
my_constants.z_lo = -40.0e-6
my_constants.z_hi =  80.0e-6

amr.max_level = 0
geometry.dims = 2
geometry.prob_lo = x_lo z_lo
geometry.prob_hi = x_hi z_hi

# Boundary condition
boundary.field_lo = pml pml
boundary.field_hi = pml pml

# Order of particle shape factors
algo.particle_shape = 3

# improved plasma stability for 2D with very low initial target temperature
# when using Esirkepov current deposition with energy-conserving field gather
interpolation.galerkin_scheme = 0

# numerical tuning
warpx.cfl = 0.999
warpx.use_filter = 1          # bilinear current/charge filter


#################################
# Performance Tuning
#
# simple tuning:
#   the numprocs product must be equal to the number of MPI ranks and splits
#   the domain on the coarsest level equally into grids;
#   slicing in the 2nd dimension is preferred for ideal performance
warpx.numprocs = 32 1  # 32 MPI ranks


#################################
# Target Profile
#

#   definitions for target extent and pre-plasma
my_constants.L    = 0.05e-6                         # [m] scale length (>0)
my_constants.Lcut = 2.0e-6                          # [m] hard cutoff from surface
my_constants.d0 = 13.0e-6                           # [m] target thickness (13micron Kapton)
my_constants.zmax = d0                              # [m] upper limit in z for particle creation
my_constants.zmin = -Lcut                           # [m] lower limit in z for particle creation
my_constants.x_cut = 1.0                            # [m] maximum initialization distance from transverse foil center
my_constants.nc = 1.7422e27 * (800e-9/lambda_L)**2  # [m^-3] critical density
my_constants.ne = 251.63                            # [unitless] fully ionized electron density in n_c
my_constants.nmin = 1.0e-6                          # [unitless] minimum density ratio compared to n_c to initialize per species
my_constants.ne_max_factor_pp = 0.3                 # [unitless] maximum pre-plasma density for ramp origin

particles.species_names = hydrogen carbon nitrogen oxygen electronsH electronsC electronsN electronsO

# "Kapton" poly(4,4'-oxydiphenylene-pyromellitimide): (C22 H10 N2 O5)n
# density ratio relative to full e- density:
#       ion-dens   e-dens
# H+:  10 / 196   10 / 196
# C6+: 22 / 196  132 / 196
# N7+:  2 / 196   14 / 196
# O8+:  5 / 196   40 / 196
#
# Possibly simplify: treat "C, N, O as X"
# H+:  10 / 196   10 / 196
# X+:  27 / 196  186 / 196  (avg. ion charge of 6.88)
#
# new ion mass has to be 12.836 * m_u (average of the ions weighted by stoichiometric ratios)
# Note: doing this might have effects on layered ion acceleration

my_constants.nr_H = 10./196.
my_constants.nr_C = 22./196.
my_constants.nr_N = 2./196.
my_constants.nr_O = 5./196.

my_constants.nr_eH = 10./196.
my_constants.nr_eC = 132./196.
my_constants.nr_eN = 14./196.
my_constants.nr_eO = 40./196.


# particle species
hydrogen.species_type = hydrogen
hydrogen.injection_style = NUniformPerCell
hydrogen.num_particles_per_cell_each_dim = 10 10
hydrogen.momentum_distribution_type = constant
hydrogen.profile = parse_density_function
hydrogen.density_min = nmin * nc # low density cut-off
hydrogen.zmin = zmin
hydrogen.zmax = zmax

carbon.species_type = carbon
carbon.injection_style = NUniformPerCell
carbon.num_particles_per_cell_each_dim = 10 10
carbon.momentum_distribution_type = constant
carbon.profile = parse_density_function
carbon.density_min = nmin * nc # low density cut-off
carbon.zmin = zmin
carbon.zmax = zmax

nitrogen.species_type = nitrogen
nitrogen.injection_style = NUniformPerCell
nitrogen.num_particles_per_cell_each_dim = 5 5
nitrogen.momentum_distribution_type = constant
nitrogen.profile = parse_density_function
nitrogen.density_min = nmin * nc # low density cut-off
nitrogen.zmin = zmin
nitrogen.zmax = zmax

oxygen.species_type = oxygen
oxygen.injection_style = NUniformPerCell
oxygen.num_particles_per_cell_each_dim = 5 15
oxygen.momentum_distribution_type = constant
oxygen.profile = parse_density_function
oxygen.density_min = nmin * nc # low density cut-off
oxygen.zmin = zmin
oxygen.zmax = zmax

electronsH.species_type = electron
electronsH.injection_style = NUniformPerCell
electronsH.num_particles_per_cell_each_dim = 10 10
electronsH.momentum_distribution_type = "maxwell_boltzmann"
electronsH.profile = parse_density_function
electronsH.density_min = nmin * nc # low density cut-off
electronsH.theta = 1.95720e-4  # 100 eV for electrons
electronsH.zmin = zmin
electronsH.zmax = zmax

electronsC.species_type = electron
electronsC.injection_style = NUniformPerCell
electronsC.num_particles_per_cell_each_dim = 10 10
electronsC.momentum_distribution_type = "maxwell_boltzmann"
electronsC.profile = parse_density_function
electronsC.density_min = nmin * nc # low density cut-off
electronsC.theta = 1.95720e-4  # 100 eV for electrons
electronsC.zmin = zmin
electronsC.zmax = zmax

electronsN.species_type = electron
electronsN.injection_style = NUniformPerCell
electronsN.num_particles_per_cell_each_dim = 5 5
electronsN.momentum_distribution_type = "maxwell_boltzmann"
electronsN.profile = parse_density_function
electronsN.density_min = nmin * nc # low density cut-off
electronsN.theta = 1.95720e-4  # 100 eV for electrons
electronsN.zmin = zmin
electronsN.zmax = zmax

electronsO.species_type = electron
electronsO.injection_style = NUniformPerCell
electronsO.num_particles_per_cell_each_dim = 5 15
electronsO.momentum_distribution_type = "maxwell_boltzmann"
electronsO.profile = parse_density_function
electronsO.density_min = nmin * nc # low density cut-off
electronsO.theta = 1.95720e-4  # 100 eV for electrons
electronsO.zmin = zmin
electronsO.zmax = zmax

# Carbon-Hydrogen Layer
# - do later if required

# density profiles (target extent, pre-plasma and cutoffs defined above particle species list)

hydrogen.density_function(x,y,z) = nr_H * ne * nc * (abs(x) < x_cut) * ((abs(z - d0/2) <= d0/2) + ne_max_factor_pp * (z > zmin) * (z < 0) * exp(-abs(z)/L))
carbon.density_function(x,y,z) = nr_C * ne * nc * (abs(x) < x_cut) * ((abs(z - d0/2) <= d0/2) + ne_max_factor_pp * (z > zmin) * (z < 0) * exp(-abs(z)/L))
nitrogen.density_function(x,y,z) = nr_N * ne * nc * (abs(x) < x_cut) * ((abs(z - d0/2) <= d0/2) + ne_max_factor_pp * (z > zmin) * (z < 0) * exp(-abs(z)/L))
oxygen.density_function(x,y,z) = nr_O * ne * nc * (abs(x) < x_cut) * ((abs(z - d0/2) <= d0/2) + ne_max_factor_pp * (z > zmin) * (z < 0) * exp(-abs(z)/L))

electronsH.density_function(x,y,z) = nr_eH * ne * nc * (abs(x) < x_cut) * ((abs(z - d0/2) <= d0/2) + ne_max_factor_pp * (z > zmin) * (z < 0) * exp(-abs(z)/L))
electronsC.density_function(x,y,z) = nr_eC * ne * nc * (abs(x) < x_cut) * ((abs(z - d0/2) <= d0/2) + ne_max_factor_pp * (z > zmin) * (z < 0) * exp(-abs(z)/L))
electronsN.density_function(x,y,z) = nr_eN * ne * nc * (abs(x) < x_cut) * ((abs(z - d0/2) <= d0/2) + ne_max_factor_pp * (z > zmin) * (z < 0) * exp(-abs(z)/L))
electronsO.density_function(x,y,z) = nr_eO * ne * nc * (abs(x) < x_cut) * ((abs(z - d0/2) <= d0/2) + ne_max_factor_pp * (z > zmin) * (z < 0) * exp(-abs(z)/L))

#################################
# Laser Pulse Profile
#
my_constants.alpha = 30. * pi / 180.                 # tilt of laser to target normal
my_constants.sz = 30.e-6                             # z-distance from laser pulse origin to focus
my_constants.sx = sz * tan(alpha)                   # x-distance from laser pulse origin to focus
my_constants.sf = sqrt(sx*sx + sz*sz)
my_constants.lambda_L = 0.815e-6                      # [m] central laser wavelength

lasers.names        = lasy_laser
lasy_laser.position     = -sx 0. -sz         # origin point the laser plane (antenna)
lasy_laser.direction    = sx 0. sz           # the plane's (antenna's) normal direction (norm of the vector does not matter)
lasy_laser.polarization = sz 0. -sx          # the main polarization vector (norm does not matter)
lasy_laser.wavelength   = lambda_L           # central wavelength of the laser pulse [m]
lasy_laser.profile      = from_file
lasy_laser.time_chunk_size = 50              # supported for both lasy and binary files; this allows to read only time_chunk_size timesteps from the file
lasy_laser.lasy_file_name = "laser_with_tod_00000.h5"   # focal distance is implemented in the laser from file, too
lasy_laser.delay = 0.0


# Of the 20J total we have 58% in Gaussian focal spot.
# The following values are just for internal normalization.
# The actual a0 will come from the input file
# without PM
lasy_laser.a0           = 54.0               # maximum amplitude of the laser field [V/m]

#################################
# Diagnostics
#
# not in these runs


#################################
# Reduced Diagnostics
#

# histograms with 2.0 degree acceptance angle in fw direction
# 2 deg * pi / 180 : 0.03490658503 rad
# half-angle +/-   : 0.017453292515 rad
warpx.reduced_diags_names                   = histuH_tp histuH_rcf histuH_fw

# Thomson-Parabola
histuH_tp.type                                 = ParticleHistogram
histuH_tp.intervals                            = 250
#histuH_tp.path                                 = "./histograms/"
histuH_tp.species                              = hydrogen
histuH_tp.bin_number                           = 1000
histuH_tp.bin_min                              = 0.0
histuH_tp.bin_max                              = 0.474  # 100 MeV protons
histuH_tp.histogram_function(t,x,y,z,ux,uy,uz) = "u2=ux*ux+uy*uy+uz*uz; if(u2>0, sqrt(u2), 0.0)"
histuH_tp.filter_function(t,x,y,z,ux,uy,uz)    = "u2=ux*ux+uy*uy+uz*uz; if(u2>0, abs(acos(uz / sqrt(u2))) <= 0.017453, 0)"

# Radio-Chromic Film Stacks
histuH_rcf.type                                 = ParticleHistogram
histuH_rcf.intervals                            = 250
#histuH_rcf.path                                 = "./histograms/"
histuH_rcf.species                              = hydrogen
histuH_rcf.bin_number                           = 1000
histuH_rcf.bin_min                              = 0.0
histuH_rcf.bin_max                              = 0.474  # 100 MeV protons
histuH_rcf.histogram_function(t,x,y,z,ux,uy,uz) = "u2=ux*ux+uy*uy+uz*uz; if(u2>0, sqrt(u2), 0.0)"
histuH_rcf.filter_function(t,x,y,z,ux,uy,uz)    = "u2=ux*ux+uy*uy+uz*uz; if(u2>0, abs(acos(uz / sqrt(u2))) <= 0.2181661564992912,0)"

# Forward-moving protons behind the cold target rear surface
histuH_fw.type                                 = ParticleHistogram
histuH_fw.intervals                            = 250
#histuH_fw.path                                 = "./histograms/"
histuH_fw.species                              = hydrogen
histuH_fw.bin_number                           = 1000
histuH_fw.bin_min                              = 0.0
histuH_fw.bin_max                              = 0.474  # 100 MeV protons
histuH_fw.histogram_function(t,x,y,z,ux,uy,uz) = "u2=ux*ux+uy*uy+uz*uz; if(u2>0, sqrt(u2), 0.0)"
histuH_fw.filter_function(t,x,y,z,ux,uy,uz)    = "(uz > 0) * (z > d0)"


#################################
# Physical Background
#
# This example is modeled after a target similar to the hydrogen jet here:
#   [1] https://doi.org/10.1038/s41598-017-10589-3
#   [2] https://arxiv.org/abs/1903.06428
#
authors = "Marco Garten <mgarten@lbl.gov>, Axel Huebl <axelhuebl@lbl.gov>"
